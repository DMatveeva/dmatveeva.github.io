---
layout: post
title: Протокол gossip
categories: Теория
---

В этом посте - поверхностный обзор протокола Gossip.

Распределенная система - это система, состоящая из нескольких узлов (серверов) объединенных в сеть, которые
выполняют некоторую полезную задачу.
В распределенной системе необходимо решать два типа задач:

1. Контроль состояния узлов в системе. Работают ли они, отключены ли.
2. Осуществление коммуникации между узлами.

Их можно решать двумя способами, используя:

1. Централизованный сервис.
2. Одноранговый (peer-to-peer) сервис.

#### 1. Централизованный сервис.

Узлы в системе не общаются напрямую. Коммуникация идет через единственный сервис, который можно реализовать в виде 
Service Discovery. Он в автоматическом порядке будет обнаруживать новые узлы в
сети, регистрировать их и мониторить состояние.

_Плюсы_: Обеспечивается высокий уровень согласованности данных.

_Минусы_: Централизованный сервис - единая точка отказа.

#### 2. Peer-to-peer сервис.

Коммуникация происходит непосредственно между узлами в сети.

_Плюсы_: Высокая доступность системы в любой момент времени, нет единой точки отказа.

_Минусы_: Согласованность может страдать.

Рассмотрим 3 способа организовать peer-to-peer коммуникацию.

1. Point-to-point (точка-точка)
2. Eager Reliable broadcast (жадная и надежная трансляция)
3. Gossip протокол

#### Point-to-point

В этом случае узел (писатель) оправляет сообщения всем остальным узлам (читателям).
На стороне писателя реализован механизм повтора отправки в случае сбоя, а на стороне читателя - механизм устранения
дублированных сообщений. Но сообщение все равно может потеряться, если оба узла, читатель и писатель, упадут.

#### Eager Reliable broadcast

Каждый узел отправляет сообщение каждому из узлов.

_Плюсы:_
- Высокая отказоустойчивасть. Даже если оба узла упадут, сообщение все равно будет переслано другими узлами.

_Минусы:_
- Каждый узел хранит информацию обо всех остальных, что приводит увеличению объемов хранилища.
- По сети передается `O(n^2)` сообщений, что может занимать значительную ширину полосы пропускания.
- Каждый узел отправляет `O(n)` сообщений, что может вести к задержкам.


#### Gossip протокол

Узел периодически отправляет сообщения некоторому случайному подмножеству других узлов.

Это похоже на то, как распространяются сплетни в офисе. Также, по-другому протокол называется epidemic,
т.к. похожим образом распространяются эпидемии.

Протокол обеспечивает согласованность данных, т.к. потерянные сообщения будут восстановлены
повторной отправкой от других узлов.

Протокол имеет параметры:
- количество соседей, которым узел случайным образом отправит
  сообщение (fanout)
- количество раз, когда будет повторен цикл отправки (cycle)

Если fanout = 1, то нужно O(log N) циклов, чтобы гарантировать, что все узлы получили сообщение (n - число узлов).

На [этом сайте представлена симуляция](https://www.serf.io/docs/internals/simulator.html), которая показывает процент узлов, получивших в итоге сообщение в
зависимости
от параметров.

_Плюсы:_
- устойчив к отказам узлов
- занимает ограниченную ширину пропускания
- отправляет меньшее количество сообщений


Типы протоколов gossip:
- Модель анти-энтропии (anti-entropy model)
- Модель распространения слухов (rumor-mongering model)


#### Аnti-entropy model

Используется для устранения несогласованности между репликами stateful сервиса, например узлами базы данных.
Сравниваются две реплики и находятся несоответствия. Затем узел с более новой версией данных рассылает сообщения другим
узлам в новых циклах.
Чтобы не обновлять весь объем данных в каждом цикле, можно находить конкретное расхождение, например, используя
контрольные суммы или дерево Меркла. И обновлять только расходящиеся данные.

#### Rumor-mongering model

Узел, получая некоторое сообщение, помечает его как "горячее".
Он начинает рассылать его другим узлам. Если некий узел уже получал такое сообщение, второй раз он его не принимает.
Наш отправитель, получив некоторое количество отказов, помечает сообщение как "негорячее", и перестает его 
рассылать.


 _**Ссылки**_:

- [http://highscalability.com/blog/2023/7/16/gossip-protocol-explained.html](http://highscalability.com/blog/2023/7/16/gossip-protocol-explained.html)
- [https://managementfromscratch.wordpress.com/2016/04/01/introduction-to-gossip/](https://managementfromscratch.wordpress.com/2016/04/01/introduction-to-gossip/)
- [https://www1.icsi.berkeley.edu/pubs/networking/ICSI_epidemicalgorithmsfor87.pdf](https://www1.icsi.berkeley.edu/pubs/networking/ICSI_epidemicalgorithmsfor87.pdf)
- [https://www.youtube.com/watch?v=77qpCahU3fo](https://www.youtube.com/watch?v=77qpCahU3fo)
